//
//  UIAlertView+CallBlock.m
//  Objctive_AssociatedObjects
//
//  Created by xuran on 16/3/25.
//  Copyright © 2016年 X.R. All rights reserved.
//

#import "UIAlertView+CallBlock.h"
#import <objc/runtime.h>

static const char* xr_delegateKey = "*xr_delegateKey*";

@interface XRAlertViewDelegate : NSObject <UIAlertViewDelegate>

@property (nonatomic, copy) void (^callBack) (UIAlertView * alert, NSInteger buttonIndex);

- (instancetype)initWithCallBack:(void (^)(UIAlertView * alert, NSInteger buttonIndex))call;

@end

@implementation XRAlertViewDelegate

- (instancetype)initWithCallBack:(void (^)(UIAlertView *, NSInteger))call {
    
    if (self = [super init]) {
        // 设置关联对象 self
        objc_setAssociatedObject(self, &xr_delegateKey, self, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
        self.callBack = [call copy];
    }
    
    return self;
}

#pragma mark - UIAlertViewDelegate

- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex {
    
    if (self.callBack) {
        self.callBack(alertView, buttonIndex);
    }
}

@end

@implementation UIAlertView (CallBlock)

- (void)clickButtonAtIndexWithCallBlock:(void (^)(UIAlertView *, NSInteger))block {
    
    // 运行时获取delegate对象
    XRAlertViewDelegate * xr_delegate = [[XRAlertViewDelegate alloc] initWithCallBack:block];
    id delegate = objc_getAssociatedObject(xr_delegate, &xr_delegateKey);
    
    self.delegate = delegate;
}

@end
